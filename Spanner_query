SELECT
    p.PROVIDER_IDENTIFICATION_NBR,
    p.NETWORK_ID,
    p.SERVICE_LOCATION_NBR,
    p.SPECIALTY_CD,
    p.PROVIDER_TYPE_CD,
    r.SERVICE_CD,
    r.SERVICE_TYPE_CD,
    r.PLACE_OF_SERVICE_CD,
    r.PRODUCT_CD,
    r.PROVIDER_BUSINESS_GROUP_NBR,
    r.ZIP_CODE_UN,
    r.RATE,
    r.PAYMENT_METHOD_CD,
    r.CONTRACT_TYPE
FROM CET_PROVIDERS p
JOIN CET_RATES r
    ON p.PROVIDER_BUSINESS_GROUP_NBR = r.PROVIDER_BUSINESS_GROUP_NBR
where 



SELECT 
    PROVIDER_BUSINESS_GROUP_NBR,
    COUNT(DISTINCT PAYMENT_METHOD_CD) AS payment_method_count
FROM 
    CET_RATES
GROUP BY 
    PROVIDER_BUSINESS_GROUP_NBR
HAVING 
    COUNT(DISTINCT PAYMENT_METHOD_CD) > 1;


SELECT 
  PROVIDER_BUSINESS_GROUP_NBR,
  PAYMENT_METHOD_CD,
FROM 
  CET_RATES
WHERE 
  PROVIDER_BUSINESS_GROUP_NBR IN (
    SELECT 
      PROVIDER_BUSINESS_GROUP_NBR
    FROM 
      CET_RATES
    GROUP BY 
      PROVIDER_BUSINESS_GROUP_NBR
    HAVING 
      COUNT(DISTINCT PAYMENT_METHOD_CD) > 1
  )
LIMIT 100;


SELECT 
    PROVIDER_BUSINESS_GROUP_NBR,
    SERVICE_CD,
    SERVICE_TYPE_CD,
    PRODUCT_CD,
    STRING_AGG(DISTINCT PAYMENT_METHOD_CD, ', ') AS payment_methods,
    COUNT(DISTINCT PAYMENT_METHOD_CD) AS payment_method_count
FROM 
    CET_RATES
GROUP BY 
    PROVIDER_BUSINESS_GROUP_NBR,
    SERVICE_CD,
    SERVICE_TYPE_CD,
    PRODUCT_CD
HAVING 
    COUNT(DISTINCT PAYMENT_METHOD_CD) > 1
ORDER BY 
    PROVIDER_BUSINESS_GROUP_NBR,
    SERVICE_CD
LIMIT 100;





SELECT
  ANY_VALUE(p.PROVIDER_IDENTIFICATION_NBR) AS PROVIDER_IDENTIFICATION_NBR,
  ANY_VALUE(p.NETWORK_ID) AS NETWORK_ID,
  ANY_VALUE(p.SERVICE_LOCATION_NBR) AS SERVICE_LOCATION_NBR,
  ANY_VALUE(p.SPECIALTY_CD) AS SPECIALTY_CD,
  ANY_VALUE(p.PROVIDER_TYPE_CD) AS PROVIDER_TYPE_CD,
  ANY_VALUE(r.SERVICE_CD) AS SERVICE_CD,
  ANY_VALUE(r.SERVICE_TYPE_CD) AS SERVICE_TYPE_CD,
  ANY_VALUE(r.PLACE_OF_SERVICE_CD) AS PLACE_OF_SERVICE_CD,
  ANY_VALUE(r.PRODUCT_CD) AS PRODUCT_CD,
  r.PROVIDER_BUSINESS_GROUP_NBR,
  ANY_VALUE(r.ZIP_CODE_UN) AS ZIP_CODE_UN,
  ANY_VALUE(r.RATE) AS RATE,
  ARRAY_AGG(DISTINCT r.PAYMENT_METHOD_CD) AS PAYMENT_METHODS,
  ANY_VALUE(r.CONTRACT_TYPE) AS CONTRACT_TYPE
FROM CET_PROVIDERS p
JOIN CET_RATES r
  ON p.PROVIDER_BUSINESS_GROUP_NBR = r.PROVIDER_BUSINESS_GROUP_NBR
GROUP BY r.PROVIDER_BUSINESS_GROUP_NBR
HAVING COUNT(DISTINCT r.PAYMENT_METHOD_CD) > 1



SELECT
  R.PROVIDER_BUSINESS_GROUP_NBR,
  ARRAY_AGG(STRUCT(
    PM.SCORE AS score,
    P.PROVIDER_TYPE_CD,
    P.PROVIDER_IDENTIFICATION_NBR,
    P.NETWORK_ID,
    P.SERVICE_LOCATION_NBR,
    P.SPECIALTY_CD,
    P.TAX_IDENTIFICATION_NBR,
    P.NATIONAL_PROVIDER_ID,
    R.SERVICE_CD,
    R.SERVICE_TYPE_CD,
    R.PLACE_OF_SERVICE_CD,
    R.PRODUCT_CD,
    R.ZIP_CD,
    R.RATE,
    R.PAYMENT_METHOD_CD,
    R.CONTRACT_TYPE
  )) AS details
FROM CET_PROVIDERS P
JOIN CET_RATES R
  ON P.PROVIDER_BUSINESS_GROUP_NBR = R.PROVIDER_BUSINESS_GROUP_NBR
  AND P.PRODUCT_CD = R.PRODUCT_CD
JOIN PAYMENT_METHOD_HIERARCHY PM
  ON R.PAYMENT_METHOD_CD = PM.PAYMENT_METHOD_CD
WHERE R.CONTRACT_TYPE IN ('N', 'C')
  AND PM.SCORE = 1
GROUP BY R.PROVIDER_BUSINESS_GROUP_NBR
LIMIT 1000;
